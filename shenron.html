<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Ruleta Shenlong</title>
  <style>
    /* Quita márgenes y relleno para usar toda la ventana */
    html, body {
      margin: 0; 
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden; 
      font-family: Arial, sans-serif;
      background-color: green; /* Fondo verde para la ruleta */
    }

    /* Contenedor a pantalla completa para videos */
    #video-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: black;
      display: none; /* Se mostrará al iniciar */
      z-index: 10;
    }

    video {
      width: 100%;
      height: 100%;
      object-fit: cover;  /* Se "estira" manteniendo proporción y recorta si sobra */
      display: block;
    }

    /* Botón "Iniciar" en el centro de la pantalla */
    #btnIniciar {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 20px 40px;
      font-size: 1.5rem;
      cursor: pointer;
      z-index: 100;
    }

    /* Contenedor de la ruleta (inicialmente oculto) */
    #ruleta-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
      text-align: center;
      z-index: 1; /* Debajo del video */
    }

    #ruleta-canvas {
      width: 600px;
      height: 600px;
      max-width: 90vw;
      max-height: 90vw;
      background: transparent;
      margin-top: 40px;
    }

    #ruleta-logo {
      position: relative;
      width: 100px;
      height: 100px;
      cursor: pointer; /* Indica que se puede clicar */
      margin-top: -340px; 
    }

    #resultado {
      font-size: 3rem;
      color: yellow;
      text-shadow: 2px 2px 4px black;
      margin-top: 20px;
      display: none;
    }

    #btnRepetir {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 1.2rem;
      cursor: pointer;
      display: none;
    }
  </style>
</head>
<body>
  <!-- Botón para iniciar la reproducción -->
  <button id="btnIniciar">Iniciar</button>

  <!-- Contenedor de videos -->
  <div id="video-container">
    <!-- Video 1: esferas -->
    <video id="videoEsferas" 
           crossorigin="anonymous"
           preload="auto"
           controls>
      <source src="https://raw.githubusercontent.com/SnchzBroz/shenglong/main/esferas.mp4" type="video/mp4">
      Tu navegador no soporta video HTML5.
    </video>

    <!-- Video 2: Shenron -->
    <video id="videoShenron"
           crossorigin="anonymous"
           preload="auto"
           style="display:none">
      <source src="https://raw.githubusercontent.com/SnchzBroz/shenglong/main/Shenron%20Chroma%20Key.mp4" type="video/mp4">
      Tu navegador no soporta video HTML5.
    </video>

    <!-- Video 3: Musica -->
    <video id="videoMusica"
           crossorigin="anonymous"
           preload="auto"
           style="display:none">
      <source src="https://raw.githubusercontent.com/SnchzBroz/shenglong/main/musica.mp4" type="video/mp4">
      Tu navegador no soporta video HTML5.
    </video>

    <!-- Audio: Voz -->
    <audio id="audioVoz"
           crossorigin="anonymous"
           preload="auto"
           style="display:none">
      <source src="https://raw.githubusercontent.com/SnchzBroz/shenglong/main/voz.aac" type="audio/aac">
      Tu navegador no soporta audio HTML5.
    </audio>
  </div>

  <!-- Contenedor de la ruleta -->
  <div id="ruleta-container">
    <canvas id="ruleta-canvas"></canvas><br>
    <img id="ruleta-logo"
         src="https://raw.githubusercontent.com/SnchzBroz/shenglong/main/Nuevo%20Logo.png"
         alt="Logo Ruleta">
    <div id="resultado"></div>
    <button id="btnRepetir">Repetir</button>
  </div>

  <!-- Librería de confeti -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.3.2/dist/confetti.browser.min.js"></script>

  <script>
    /*************************************************************
     * Referencias del DOM
     *************************************************************/
    const btnIniciar      = document.getElementById('btnIniciar');
    const videoContainer  = document.getElementById('video-container');
    const videoEsferas    = document.getElementById('videoEsferas');
    const videoShenron    = document.getElementById('videoShenron');
    const videoMusica     = document.getElementById('videoMusica');
    const audioVoz        = document.getElementById('audioVoz');
    const ruletaContainer = document.getElementById('ruleta-container');
    const ruletaCanvas    = document.getElementById('ruleta-canvas');
    const ruletaLogo      = document.getElementById('ruleta-logo');
    const resultadoDiv    = document.getElementById('resultado');
    const btnRepetir      = document.getElementById('btnRepetir');

    let endedCount = 0;

    // Sonidos de la ruleta (ejemplo, sustituye si necesitas)
    const audioSanchezBroz = new Audio("https://raw.githubusercontent.com/SnchzBroz/shenglong/main/sanchezbroz.mp3");
    const sonidoGiro       = new Audio("https://www.soundjay.com/buttons/button-09a.mp3");
    const sonidoDesacelera = new Audio("https://www.soundjay.com/buttons/button-10a.mp3");
    const sonidoResultado  = new Audio("https://www.soundjay.com/buttons/button-3.mp3");

    // Opciones de la ruleta
    const opciones = [
      "Opción 1",
      "Opción 2",
      "Opción 3",
      "Opción 4",
      "Opción 5",
      "Opción 6",
      "Opción 7",
      "Opción 8",
      "Opción 9",
      "Opción 10"
    ];
    const numOpciones   = opciones.length;
    const anguloSeccion = 360 / numOpciones;

    let girando       = false;
    let anguloActual  = 0;
    let velocidadGiro = 0;
    let animacionFrame;
    const ctx = ruletaCanvas.getContext('2d');

    /*************************************************************
     * Botón Iniciar
     *************************************************************/
    btnIniciar.addEventListener('click', () => {
      // Ocultamos el botón
      btnIniciar.style.display = 'none';

      // Mostramos contenedor de videos
      videoContainer.style.display = 'block';
      // Aseguramos que el primer video esté visible (por si estaba en display:none)
      videoEsferas.style.display = 'block';

      // Reiniciamos contadores
      endedCount = 0;

      // Empezamos con el primer video
      videoEsferas.currentTime = 0;
      videoEsferas.play().catch(err => {
        console.error("Error al reproducir esferas:", err);
      });
    });

    /*************************************************************
     * Reproducción en cadena de videos
     *************************************************************/
    videoEsferas.addEventListener('ended', () => {
      // Ocultamos el primer video
      videoEsferas.style.display = 'none';

      // Inicia Shenron
      videoShenron.style.display = 'block';
      videoShenron.currentTime = 0;
      videoShenron.play().catch(err => {
        console.error("Error al reproducir Shenron:", err);
      });

      // A los 2 seg. de iniciar Shenron, arrancamos musica y voz
      setTimeout(() => {
        videoMusica.style.display = 'block';
        videoMusica.currentTime = 0;
        videoMusica.play().catch(err => {
          console.error("Error al reproducir Musica:", err);
        });

        audioVoz.currentTime = 0;
        audioVoz.play().catch(err => {
          console.error("Error al reproducir Voz:", err);
        });
      }, 2000);
    });

    videoShenron.addEventListener('ended', ()=> checkAllEnded());
    videoMusica.addEventListener('ended',  ()=> checkAllEnded());
    audioVoz.addEventListener('ended',     ()=> checkAllEnded());

    function checkAllEnded(){
      endedCount++;
      // Cuando los tres (Shenron, Musica, Voz) han terminado:
      if (endedCount === 3) {
        videoShenron.style.display = 'none';
        videoMusica.style.display  = 'none';
        // Ocultamos contenedor de videos
        videoContainer.style.display = 'none';

        // Mostramos la ruleta
        ruletaContainer.style.display = 'block';
        dibujarRuleta();
      }
    }

    /*************************************************************
     * Ruleta
     *************************************************************/
    function dibujarRuleta() {
      // Tamaño fijo en el canvas
      const w = ruletaCanvas.width  = 600;
      const h = ruletaCanvas.height = 600;
      const centroX = w/2;
      const centroY = h/2;
      const radio   = Math.min(centroX, centroY) - 10;

      ctx.clearRect(0, 0, w, h);
      for (let i = 0; i < numOpciones; i++) {
        const angInicio = (anguloSeccion * i + anguloActual) * Math.PI/180;
        const angFin    = (anguloSeccion * (i+1) + anguloActual) * Math.PI/180;

        // Secciones alternando color
        ctx.fillStyle = (i % 2 === 0) ? "#f1c40f" : "#e67e22";
        ctx.beginPath();
        ctx.moveTo(centroX, centroY);
        ctx.arc(centroX, centroY, radio, angInicio, angFin);
        ctx.closePath();
        ctx.fill();

        // Texto
        ctx.save();
        ctx.fillStyle = "#000";
        ctx.translate(centroX, centroY);
        ctx.rotate((angInicio + angFin)/2);
        ctx.textAlign = "right";
        ctx.font = "bold 18px sans-serif";
        ctx.fillText(opciones[i], radio - 10, 5);
        ctx.restore();
      }
    }

    function actualizarRuleta() {
      anguloActual += velocidadGiro;
      anguloActual %= 360;
      velocidadGiro *= 0.97; // frenado

      // Sonido girando
      if (velocidadGiro > 5) {
        if (sonidoGiro.paused) {
          sonidoGiro.currentTime = 0;
          sonidoGiro.play().catch(()=>{});
        }
      }

      if (velocidadGiro < 0.3) {
        velocidadGiro = 0;
        girando = false;
        cancelAnimationFrame(animacionFrame);

        // Paramos sonido de giro
        sonidoGiro.pause();
        sonidoGiro.currentTime = 0;

        // Sonido resultado
        sonidoResultado.play().catch(()=>{});

        // Determinar opción ganadora
        const anguloFinal = (anguloActual % 360 + 360) % 360; 
        const index = Math.floor(((360 - anguloFinal + anguloSeccion/2) % 360) / anguloSeccion);
        const opcionGanadora = opciones[index];

        // Mostrar resultado
        resultadoDiv.innerText = "¡Ganaste: " + opcionGanadora + "!";
        resultadoDiv.style.display = "block";

        // Confeti
        lanzarConfeti();

        // A 1 segundo, "sanchezbroz.mp3"
        setTimeout(() => {
          audioSanchezBroz.play().catch(()=>{});
        }, 1000);

        // Botón repetir
        btnRepetir.style.display = "inline-block";
        return;
      }

      dibujarRuleta();
      animacionFrame = requestAnimationFrame(actualizarRuleta);
    }

    function girarRuleta() {
      if (girando) return;
      girando = true;
      resultadoDiv.style.display = 'none';
      btnRepetir.style.display = 'none';

      // Reiniciar
      sonidoResultado.pause();
      sonidoResultado.currentTime = 0;

      // Velocidad inicial aleatoria
      velocidadGiro = 15 + Math.random()*10;

      // Iniciar sonido de giro
      sonidoGiro.currentTime = 0;
      sonidoGiro.play().catch(()=>{});

      // Iniciar animación
      actualizarRuleta();
    }

    function lanzarConfeti() {
      const duracion = 2000; 
      const end = Date.now() + duracion;
      (function frame() {
        confetti({
          particleCount: 5,
          angle: Math.random() * 60 + 160,
          spread: 55,
          origin: {
            x: Math.random(),
            y: Math.random() - 0.2
          }
        });
        if (Date.now() < end) {
          requestAnimationFrame(frame);
        }
      })();
    }

    /*************************************************************
     * Evento de click en el logo para girar
     *************************************************************/
    ruletaLogo.addEventListener('click', girarRuleta);

    /*************************************************************
     * Botón Repetir
     *************************************************************/
    btnRepetir.addEventListener('click', () => {
      // Ocultamos ruleta, resultado, y botón
      ruletaContainer.style.display = 'none';
      resultadoDiv.style.display = 'none';
      btnRepetir.style.display = 'none';

      // Reiniciar videos
      videoShenron.pause(); videoShenron.currentTime = 0; videoShenron.style.display = 'none';
      videoMusica.pause(); videoMusica.currentTime = 0; videoMusica.style.display = 'none';
      audioVoz.pause();    audioVoz.currentTime = 0;

      // Reiniciamos contadores
      endedCount = 0;

      // Mostramos de nuevo contenedor de videos
      videoContainer.style.display = 'block';
      videoEsferas.style.display = 'block';

      // Reproducimos el primer video
      videoEsferas.currentTime = 0;
      videoEsferas.play().catch(err => {
        console.error("Error al reproducir esferas:", err);
      });
    });
  </script>
</body>
</html>
