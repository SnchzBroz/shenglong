<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Ruleta Shenlong</title>
  <style>
    /* Ocupamos toda la pantalla, fondo verde para chroma key */
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      font-family: Arial, sans-serif;
      background-color: green; /* Fondo verde */
    }

    /* Contenedor de la ruleta */
    #ruleta-container {
      width: 100%;
      height: 100%;
      text-align: center;
      position: relative;
    }

    /* Lienzo de la ruleta */
    #ruleta-canvas {
      width: 600px;
      height: 600px;
      max-width: 90vw;
      max-height: 90vw;
      background: transparent;
      margin-top: 40px;
    }

    /* Logo en el centro de la ruleta (clic para girar) */
    #ruleta-logo {
      width: 100px;
      height: 100px;
      cursor: pointer;
      position: relative;
      margin-top: -340px; /* Ajusta para centrar sobre el canvas */
    }

    /* Mensaje de resultado */
    #resultado {
      font-size: 3rem;
      color: yellow;
      text-shadow: 2px 2px 4px black;
      margin-top: 20px;
      display: none; /* Se mostrará cuando haya resultado */
    }

    /* Botón para repetir la ruleta */
    #btnRepetir {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 1.2rem;
      cursor: pointer;
      display: none; /* Aparece cuando acaba la ruleta */
    }
  </style>
</head>
<body>
  <!-- Contenedor principal de la ruleta -->
  <div id="ruleta-container">
    <canvas id="ruleta-canvas"></canvas><br>
    <img id="ruleta-logo"
         src="https://raw.githubusercontent.com/SnchzBroz/shenglong/main/Nuevo%20Logo.png"
         alt="Logo Ruleta">
    <div id="resultado"></div>
    <button id="btnRepetir">Repetir</button>
  </div>

  <!-- Librería de confeti -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.3.2/dist/confetti.browser.min.js"></script>

  <script>
    /*************************************************************
     * Referencias a elementos del DOM
     *************************************************************/
    const ruletaContainer = document.getElementById('ruleta-container');
    const ruletaCanvas    = document.getElementById('ruleta-canvas');
    const ruletaLogo      = document.getElementById('ruleta-logo');
    const resultadoDiv    = document.getElementById('resultado');
    const btnRepetir      = document.getElementById('btnRepetir');

    /*************************************************************
     * Configuración de la ruleta
     *************************************************************/
    const opciones = [
      "Opción 1",
      "Opción 2",
      "Opción 3",
      "Opción 4",
      "Opción 5",
      "Opción 6",
      "Opción 7",
      "Opción 8",
      "Opción 9",
      "Opción 10"
    ];
    const numOpciones   = opciones.length;
    const anguloSeccion = 360 / numOpciones;

    const ctx = ruletaCanvas.getContext('2d');

    let girando       = false;
    let anguloActual  = 0;
    let velocidadGiro = 0;
    let animacionFrame;

    /*************************************************************
     * Sonidos (modifica las URLs según tu repositorio)
     *************************************************************/
    const audioSanchezBroz = new Audio("https://raw.githubusercontent.com/SnchzBroz/shenglong/main/sanchezbroz.mp3");
    const sonidoGiro       = new Audio("https://www.soundjay.com/buttons/button-09a.mp3");
    const sonidoResultado  = new Audio("https://www.soundjay.com/buttons/button-3.mp3");
    // Si deseas un sonido de desaceleración, puedes agregarlo.

    /*************************************************************
     * Funciones para dibujar y girar la ruleta
     *************************************************************/
    function dibujarRuleta() {
      // Ajustamos el canvas a un tamaño fijo
      const w = ruletaCanvas.width  = 600;
      const h = ruletaCanvas.height = 600;

      const centroX = w / 2;
      const centroY = h / 2;
      const radio   = Math.min(centroX, centroY) - 10; 

      // Limpiamos el canvas
      ctx.clearRect(0, 0, w, h);

      // Dibujamos cada sección
      for (let i = 0; i < numOpciones; i++) {
        const angInicio = (anguloSeccion * i + anguloActual) * Math.PI / 180;
        const angFin    = (anguloSeccion * (i + 1) + anguloActual) * Math.PI / 180;

        // Alternamos colores de las secciones
        ctx.fillStyle = (i % 2 === 0) ? "#f1c40f" : "#e67e22";

        ctx.beginPath();
        ctx.moveTo(centroX, centroY);
        ctx.arc(centroX, centroY, radio, angInicio, angFin);
        ctx.closePath();
        ctx.fill();

        // Texto en cada sección
        ctx.save();
        ctx.fillStyle = "#000";
        ctx.translate(centroX, centroY);
        ctx.rotate((angInicio + angFin) / 2);
        ctx.textAlign = "right";
        ctx.font = "bold 18px sans-serif";
        ctx.fillText(opciones[i], radio - 10, 5);
        ctx.restore();
      }
    }

    function actualizarRuleta() {
      anguloActual += velocidadGiro;
      anguloActual %= 360;
      // Desaceleramos de manera progresiva
      velocidadGiro *= 0.97;

      // Sonido mientras gira
      if (velocidadGiro > 5) {
        if (sonidoGiro.paused) {
          sonidoGiro.currentTime = 0;
          sonidoGiro.play().catch(()=>{});
        }
      }

      if (velocidadGiro < 0.3) {
        // Paramos
        velocidadGiro = 0;
        girando = false;
        cancelAnimationFrame(animacionFrame);

        // Detenemos el sonido de giro
        sonidoGiro.pause();
        sonidoGiro.currentTime = 0;

        // Sonido final
        sonidoResultado.play().catch(()=>{});

        // Calculamos la opción ganadora
        const anguloFinal = (anguloActual % 360 + 360) % 360;
        const index = Math.floor(((360 - anguloFinal + anguloSeccion / 2) % 360) / anguloSeccion);
        const opcionGanadora = opciones[index];

        // Mostramos el resultado
        resultadoDiv.innerText = "¡Ganaste: " + opcionGanadora + "!";
        resultadoDiv.style.display = "block";

        // Lanzamos confeti
        lanzarConfeti();

        // A 1 segundo, reproducimos "sanchezbroz.mp3"
        setTimeout(() => {
          audioSanchezBroz.play().catch(()=>{});
        }, 1000);

        // Mostramos el botón "Repetir"
        btnRepetir.style.display = 'inline-block';
        return;
      }

      dibujarRuleta();
      animacionFrame = requestAnimationFrame(actualizarRuleta);
    }

    function girarRuleta() {
      if (girando) return;
      girando = true;
      resultadoDiv.style.display = 'none';
      btnRepetir.style.display   = 'none';

      // Reiniciamos el sonido de resultado por si estaba sonando
      sonidoResultado.pause();
      sonidoResultado.currentTime = 0;

      // Velocidad de giro inicial (aleatoria)
      velocidadGiro = 15 + Math.random() * 10;

      // Iniciamos el sonido de giro
      sonidoGiro.currentTime = 0;
      sonidoGiro.play().catch(()=>{});

      // Iniciamos animación
      actualizarRuleta();
    }

    // Función para lanzar confeti
    function lanzarConfeti() {
      const duration = 2 * 1000; // 2 segundos
      const end = Date.now() + duration;
      (function frame() {
        confetti({
          particleCount: 5,
          angle: Math.random() * 60 + 160,
          spread: 55,
          origin: {
            x: Math.random(),
            y: Math.random() - 0.2
          }
        });
        if (Date.now() < end) {
          requestAnimationFrame(frame);
        }
      })();
    }

    /*************************************************************
     * Eventos
     *************************************************************/
    // Girar la ruleta al hacer clic en el logo
    ruletaLogo.addEventListener('click', girarRuleta);

    // Botón para repetir
    btnRepetir.addEventListener('click', () => {
      // Ocultamos el resultado y el botón
      resultadoDiv.style.display = 'none';
      btnRepetir.style.display   = 'none';

      // Reseteamos la ruleta
      anguloActual  = 0;
      velocidadGiro = 0;
      dibujarRuleta();
    });

    /*************************************************************
     * Inicialización
     *************************************************************/
    // Dibujamos la ruleta al cargar la página
    dibujarRuleta();
  </script>
</body>
</html>
