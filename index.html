<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Ruleta Shenlong</title>
  <style>
    /* Ocupan toda la pantalla, fondo verde */
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      font-family: Arial, sans-serif;
      background-color: green; /* Chroma key */
    }

    /* Contenedor principal (flex) para centrar la ruleta en pantalla */
    #ruleta-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100vh;
      position: relative;
    }

    /* Envoltorio para canvas de la ruleta */
    #ruleta-wrapper {
      position: relative;
      width: 600px;
      height: 600px;
      max-width: 90vw;
      max-height: 90vw;
    }

    /* Lienzo de la ruleta */
    #ruleta-canvas {
      width: 100%;
      height: 100%;
      background: transparent;
    }

    /* Flecha: inicialmente OCULTA. Será un triángulo que apunta hacia "arriba" por defecto,
       luego lo rotamos para que apunte al centro. */
    #flecha {
      display: none;       /* Se muestra al final, en el sector ganador */
      position: absolute;
      width: 0;
      height: 0;
      border-left: 15px solid transparent;
      border-right: 15px solid transparent;
      border-bottom: 30px solid red; /* Flecha que apunta hacia ARRIBA por defecto */
      z-index: 2;
    }

    /* LOGO al 60% del ancho de la pantalla, en grande. 
       scale(1) de base. */
    #big-logo {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(1);
      transform-origin: center;
      width: 60vw;       /* 60% del ancho de la ventana */
      height: auto;      /* Mantiene proporción */
      transition: transform 1s ease; /* Se encoge en 1s */
      z-index: 3;
      cursor: pointer;   /* Para indicar que se puede clicar */
    }
    /* Cuando le agregamos la clase .shrink => scale(0.2) */
    #big-logo.shrink {
      transform: translate(-50%, -50%) scale(0.2);
    }

    /* Mensaje de resultado */
    #resultado {
      font-size: 3rem;
      color: yellow;
      text-shadow: 2px 2px 4px black;
      margin-top: 30px;
      display: none;
    }

    /* Botón Repetir */
    #btnRepetir {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 1.2rem;
      cursor: pointer;
      display: none;
    }
  </style>
</head>
<body>

<div id="ruleta-container">
  <!-- Ruleta (canvas) con flecha superpuesta -->
  <div id="ruleta-wrapper">
    <canvas id="ruleta-canvas"></canvas>
    <div id="flecha"></div>
    <!-- Logo grande al centro (60% pantalla). Al hacer clic => se encoge => inicia ruleta -->
    <img id="big-logo"
         src="https://raw.githubusercontent.com/SnchzBroz/shenglong/main/Nuevo%20Logo.png"
         alt="Logo Shenlong">
  </div>

  <div id="resultado"></div>
  <button id="btnRepetir">Repetir</button>
</div>

<!-- Librería de confeti -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.3.2/dist/confetti.browser.min.js"></script>

<script>
/*************************************************************
 * Referencias del DOM
 *************************************************************/
const ruletaWrapper = document.getElementById('ruleta-wrapper');
const ruletaCanvas  = document.getElementById('ruleta-canvas');
const ctx           = ruletaCanvas.getContext('2d');

const flecha        = document.getElementById('flecha');
const bigLogo       = document.getElementById('big-logo');
const resultadoDiv  = document.getElementById('resultado');
const btnRepetir    = document.getElementById('btnRepetir');

/*************************************************************
 * Sonidos (ajusta URLs si difieren en tu repo)
 *************************************************************/
const audioSanchezBroz = new Audio("https://raw.githubusercontent.com/SnchzBroz/shenglong/main/sanchezbroz.mp3");
const sonidoGiro       = new Audio("https://www.soundjay.com/buttons/button-09a.mp3");
const sonidoResultado  = new Audio("https://www.soundjay.com/buttons/button-3.mp3");

/*************************************************************
 * Configuración de la ruleta
 *************************************************************/
const opciones = [
  "Opción 1",
  "Opción 2",
  "Opción 3",
  "Opción 4",
  "Opción 5",
  "Opción 6",
  "Opción 7",
  "Opción 8",
  "Opción 9",
  "Opción 10"
];

const numOpciones   = opciones.length;
const anguloSeccion = 360 / numOpciones;

// Variables de giro
let anguloActual  = 0;  // acumulado en degrees
let velocidadGiro = 0;  // degrees/frame
let girando       = false;
let animacionFrame;
let startTime     = 0;  // para medir al menos 10s de giro

/*************************************************************
 * Dibujar la ruleta en el canvas
 *************************************************************/
function dibujarRuleta() {
  // Ajustar el canvas al tamaño del contenedor
  const w = ruletaCanvas.width  = ruletaWrapper.offsetWidth;
  const h = ruletaCanvas.height = ruletaWrapper.offsetHeight;

  const centroX = w / 2;
  const centroY = h / 2;
  const radio   = Math.min(centroX, centroY) - 10;

  ctx.clearRect(0, 0, w, h);

  for (let i = 0; i < numOpciones; i++) {
    const angInicio = (anguloSeccion * i + anguloActual) * Math.PI / 180;
    const angFin    = (anguloSeccion * (i + 1) + anguloActual) * Math.PI / 180;

    // Alternar color
    ctx.fillStyle = (i % 2 === 0) ? "#f1c40f" : "#e67e22";

    ctx.beginPath();
    ctx.moveTo(centroX, centroY);
    ctx.arc(centroX, centroY, radio, angInicio, angFin);
    ctx.closePath();
    ctx.fill();

    // Texto
    ctx.save();
    ctx.fillStyle = "#000";
    ctx.translate(centroX, centroY);
    ctx.rotate((angInicio + angFin) / 2);
    ctx.textAlign = "right";
    ctx.font = "bold 18px sans-serif";
    ctx.fillText(opciones[i], radio - 10, 5);
    ctx.restore();
  }
}

/*************************************************************
 * Animación de giro (mínimo 10 seg)
 *************************************************************/
function actualizarRuleta(timestamp) {
  if (!startTime) {
    startTime = timestamp;
  }
  const elapsed = (timestamp - startTime) / 1000; // segundos transcurridos

  // Aumentar ángulo
  anguloActual += velocidadGiro;
  anguloActual %= 360;

  // Mantener velocidad > 10s, luego desacelerar
  if (elapsed >= 10) {
    velocidadGiro *= 0.98; // factor de frenado
  }

  // Sonido giro si va rápido
  if (velocidadGiro > 1) {
    if (sonidoGiro.paused) {
      sonidoGiro.currentTime = 0;
      sonidoGiro.play().catch(()=>{});
    }
  }

  // Condición de parada
  if (velocidadGiro < 0.3) {
    velocidadGiro = 0;
    girando = false;
    cancelAnimationFrame(animacionFrame);

    // Parar sonido de giro
    sonidoGiro.pause();
    sonidoGiro.currentTime = 0;

    // Sonido resultado
    sonidoResultado.play().catch(()=>{});

    // Determinar opción ganadora con la "flecha imaginaria" a la derecha:
    // index = ...
    // Usamos la fórmula anterior para compatibilidad:
    const anguloFinal = (anguloActual + 360) % 360;
    // "Flecha" a la derecha => arrowAngle = (90 - anguloFinal + 360) % 360
    const arrowAngle  = (90 - anguloFinal + 360) % 360;
    // index
    const index = Math.floor((arrowAngle + anguloSeccion/2) / anguloSeccion) % numOpciones;
    const opcionGanadora = opciones[index];

    // Mostrar resultado
    resultadoDiv.innerText = "¡Ganaste: " + opcionGanadora + "!";
    resultadoDiv.style.display = 'block';

    // Poner la flecha EXACTAMENTE en el sector ganador,
    // apuntando hacia el centro. 
    colocarFlechaGanadora(index, anguloFinal);

    // Confeti
    lanzarConfeti();

    // 1 seg después -> sanchezbroz.mp3
    setTimeout(() => {
      audioSanchezBroz.play().catch(()=>{});
    }, 1000);

    // Botón Repetir
    btnRepetir.style.display = 'inline-block';
    return;
  }

  // Pintar la ruleta
  dibujarRuleta();
  animacionFrame = requestAnimationFrame(actualizarRuleta);
}

/*************************************************************
 * Colocar la flecha en el sector ganador
 *************************************************************/
function colocarFlechaGanadora(index, anguloFinal) {
  // Calculamos el ángulo "absoluto desde arriba (0°=top)" 
  // del centro de la sección ganadora:
  // La sección "index" va desde index*anguloSeccion hasta (index+1)*anguloSeccion
  // Su centro es (index + 0.5)*anguloSeccion
  // El wheel gira 'anguloFinal' => sumamos
  const sectorCenter = index * anguloSeccion + anguloSeccion / 2; 
  let winningAngleFromTop = (sectorCenter + anguloFinal) % 360;

  // Coordenadas en el canvas (0°=top)
  // x = centroX + r * sin(angRad)
  // y = centroY - r * cos(angRad)
  const w = ruletaCanvas.width;
  const h = ruletaCanvas.height;
  const cx = w / 2;
  const cy = h / 2;
  const r  = Math.min(cx, cy) - 10;

  const angRad = (winningAngleFromTop * Math.PI) / 180;
  const flechaX = cx + r * Math.sin(angRad);
  const flechaY = cy - r * Math.cos(angRad);

  flecha.style.left = flechaX + "px";
  flecha.style.top  = flechaY + "px";

  // Rotamos la flecha para que apunte al centro.
  // Si 0° es top, la flecha por defecto "apunta arriba".
  // Para apuntar hacia el centro, sumamos 180°.
  // (Si angle=0 => top, rotate(180) => flecha hacia abajo => apuntando al centro).
  const arrowRotation = (winningAngleFromTop + 180) % 360;
  flecha.style.transform = `translate(-50%, -50%) rotate(${arrowRotation}deg)`;

  // Mostrar flecha
  flecha.style.display = "block";
}

/*************************************************************
 * Iniciar el giro
 *************************************************************/
function girarRuleta() {
  if (girando) return;
  girando = true;

  // Ocultamos resultado y flecha antes de iniciar
  resultadoDiv.style.display = 'none';
  flecha.style.display       = 'none';
  btnRepetir.style.display   = 'none';

  // Reiniciamos sonido de resultado
  sonidoResultado.pause();
  sonidoResultado.currentTime = 0;

  // Velocidad inicial 
  velocidadGiro = 12;
  startTime     = 0; // reiniciamos el conteo

  animacionFrame = requestAnimationFrame(actualizarRuleta);
}

/*************************************************************
 * Cuando hago clic en el logo grande => se encoge => al terminar => gira
 *************************************************************/
bigLogo.addEventListener('click', () => {
  // Si ya está encogido, no hacemos nada
  if (bigLogo.classList.contains('shrink')) return;

  // Iniciamos la transición
  bigLogo.classList.add('shrink');

  // Al terminar la transición => girar
  bigLogo.addEventListener('transitionend', onLogoShrunk, { once: true });
});

function onLogoShrunk() {
  girarRuleta();
}

/*************************************************************
 * Confeti
 *************************************************************/
function lanzarConfeti() {
  const duration = 2000; // 2s
  const end = Date.now() + duration;
  (function frame() {
    confetti({
      particleCount: 5,
      angle: Math.random() * 60 + 160,
      spread: 55,
      origin: { x: Math.random(), y: Math.random() - 0.2 }
    });
    if (Date.now() < end) {
      requestAnimationFrame(frame);
    }
  })();
}

/*************************************************************
 * Botón Repetir
 *************************************************************/
btnRepetir.addEventListener('click', () => {
  // Reset de la ruleta
  anguloActual  = 0;
  velocidadGiro = 0;
  dibujarRuleta();

  // Ocultar resultado, flecha y botón
  resultadoDiv.style.display = 'none';
  flecha.style.display       = 'none';
  btnRepetir.style.display   = 'none';

  // Devolver el logo a grande (60% pantalla)
  bigLogo.classList.remove('shrink');
  // Forzar reflow
  void bigLogo.offsetWidth;

  // Ahora el logo espera un clic para encoger y girar
});

/*************************************************************
 * Al cargar la página, dibujamos la ruleta
 *************************************************************/
window.addEventListener('load', () => {
  dibujarRuleta();
});
</script>
</body>
</html>
